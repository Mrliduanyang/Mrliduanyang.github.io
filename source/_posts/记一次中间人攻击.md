---
title: 记一次中间人攻击
date: 2020-12-01 08:46:58
categories: 杂七杂八
---

## 0x00前言

因为疫情防控原因，进出学校需要提前申请，之后在校门口处扫码验证。在之前一段时间，申请比较容易，无需辅导员审核。但后来由于疫情反弹，审核变的复杂了。但这难不倒聪明的打工人。

## 0x01抓包分析

进出扫码用的APP，是一个网页+套壳浏览器的形式，所有的用户界面，本质都是网页。因此，从理论上讲，只要修改服务器的响应数据，就可以将页面修改为任何我们想要的效果，自然也包括把原本的验证失败改为验证成功。

之前有过用*Fiddler*抓包的经验，打开*Fiddler*，设置代理，手机和电脑连接同一个*WiFi*并手动设置代理，这样手机上的所有流量便会通过代理进行转发。*Fiddler*提供了很便捷的脚本来处理请求和响应数据，按照教程对指定*URL*请求的*Response*进行修改，替换掉其*HTML*中的部分数据即可达到需求。

但上述验证都是在局域网环境中完成的，真正在校门口扫码时不可能连接上自己的局域网，但又想到，学校是有校园网的，校园网中的设备都会分配到一个内网*ip*，于是把电脑和手机都切换到校园网中，并手动设置*ip*使之在同一个网段。但没想到的是，校园网中大概做了*AP*隔离，设备之间是无法访问的，没办法，只能在公网搭建服务了。

## 0x02应用部署

在公网部署的话，肯定不能像之前一样安装*Fiddler*软件了，而且*Fiddler*也不提供调用接口，没法用代码来处理请求及响应数据。搜索之后发现*mitmproxy*是一个很经典的中间人工具代理工具，并且提供了*Python*接口。**纸上谈来终觉浅**，坑太多了，一言难尽。想多废话几句，先是在*Windows*主机安装，但安装后手机连接不上代理，一度怀疑是工具的问题。转而在*WSL*里安装，安装后启动，还是无法连接。更加怀疑是工具问题。一度想要换个工具的时候，又倔强的在一个独立的*Ubuntu*开发板上安装了一下，惊了，竟然可以。又转头去*WSL*中用*cURL*带着代理参数测试请求，也可以，说明代理没问题，就是因为其他原因连接不上。排查过程过于智障，就不在此表述了。总的就是，*Windows*防火墙没有添加端口的入站规则，*WSL*的*ip*和主机的*ip*不是一个，虽然他们的共用端口。解决完连接问题，剩下的就简单了，按照*mitmproxy*的教程，编写*Python*代码，对指定接口的响应数据做修改，又因为涉及到对页面元素的增、删、改，所以又用了*BeautifulSoup*来处理。

部署完，验证好用，**(command &)**丢后台运行了，然后把使用说明分享给小伙伴啦！